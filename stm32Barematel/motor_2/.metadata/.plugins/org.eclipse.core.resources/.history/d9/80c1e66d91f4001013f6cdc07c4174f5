/* USER CODE BEGIN Header */
/**
  ******************************************************************************
  * @file           : main.c
  * @brief          : Radar Project - Servo + Ultrasonic + UART
  ******************************************************************************
  */
/* USER CODE END Header */

#include "main.h"
#include <stdio.h>
#include <string.h>

/* Private variables ---------------------------------------------------------*/
TIM_HandleTypeDef htim2;
UART_HandleTypeDef huart2;

/* -------- PIN DEFINES -------- */
#define TRIG_PIN GPIO_PIN_1
#define TRIG_PORT GPIOA

#define ECHO_PIN GPIO_PIN_2
#define ECHO_PORT GPIOA

#define SERVO_CHANNEL TIM_CHANNEL_1

uint32_t echoTime = 0;
float distance = 0;
char msg[40];

/* USER CODE BEGIN 0 */

/* Microsecond delay using TIM2 */
void delay_us(uint16_t us)
{
  __HAL_TIM_SET_COUNTER(&htim2, 0);
  while(__HAL_TIM_GET_COUNTER(&htim2) < us);
}

/* Read distance from HC-SR04 */
float HCSR04_Read(void)
{
  HAL_GPIO_WritePin(TRIG_PORT, TRIG_PIN, GPIO_PIN_RESET);
  delay_us(2);

  HAL_GPIO_WritePin(TRIG_PORT, TRIG_PIN, GPIO_PIN_SET);
  delay_us(10);
  HAL_GPIO_WritePin(TRIG_PORT, TRIG_PIN, GPIO_PIN_RESET);

  while(HAL_GPIO_ReadPin(ECHO_PORT, ECHO_PIN) == GPIO_PIN_RESET);

  __HAL_TIM_SET_COUNTER(&htim2, 0);

  while(HAL_GPIO_ReadPin(ECHO_PORT, ECHO_PIN) == GPIO_PIN_SET);

  echoTime = __HAL_TIM_GET_COUNTER(&htim2);

  distance = (echoTime * 0.0343f) / 2.0f;

  return distance;
}

/* Set servo angle */
void Servo_SetAngle(uint8_t angle)
{
  uint16_t pulse = 250 + (angle * 5);
  __HAL_TIM_SET_COMPARE(&htim2, SERVO_CHANNEL, pulse);
}

/* USER CODE END 0 */

/* ================= MAIN ================= */
int main(void)
{
  HAL_Init();
  SystemClock_Config();

  MX_GPIO_Init();
  MX_USART2_UART_Init();
  MX_TIM2_Init();

  HAL_TIM_PWM_Start(&htim2, SERVO_CHANNEL);

  while (1)
  {
    for(int angle = 15; angle <= 165; angle++)
    {
      Servo_SetAngle(angle);
      HAL_Delay(30);

      distance = HCSR04_Read();

      sprintf(msg, "%d,%d.\r\n", angle, (int)distance);
      HAL_UART_Transmit(&huart2, (uint8_t*)msg, strlen(msg), 100);
    }

    for(int angle = 165; angle >= 15; angle--)
    {
      Servo_SetAngle(angle);
      HAL_Delay(30);

      distance = HCSR04_Read();

      sprintf(msg, "%d,%d.\r\n", angle, (int)distance);
      HAL_UART_Transmit(&huart2, (uint8_t*)msg, strlen(msg), 100);
    }
  }
}
