/*
 * main.c
 *
 *  Created on: Dec 26, 2025
 *      Author: NIVYA
 */

#include "stm32f446xx.h"
#include "stm32f446xx_gpio_driver.h"
#include "stm32f446xx_usart_driver.h"
#include "stm32f446xx_rcc_driver.h"
#include <stdint.h>
#include <stdio.h>

#define TRIG_PIN   GPIO_PIN_NO_0   // PA0
#define ECHO_PIN   GPIO_PIN_NO_1   // PA1
#define LED_PIN    GPIO_PIN_NO_5   // PA5 (Onboard LED)

#define DISTANCE_THRESHOLD_CM  5  // LED ON when distance < 5 cm

// USART2 handle
USART_Handle_t USART2Handle;

// crude delay (approx microseconds)
void delay_us(uint32_t us)
{
    for (volatile uint32_t i = 0; i < us * 10; i++);
}

// measure distance in cm
uint32_t measure_distance_cm(void)
{
    uint32_t timeout = 30000;

    // Trigger pulse: 10 µs
    GPIO_WriteToOutputPin(GPIOA, TRIG_PIN, GPIO_PIN_RESET);
    delay_us(2);
    GPIO_WriteToOutputPin(GPIOA, TRIG_PIN, GPIO_PIN_SET);
    delay_us(10);
    GPIO_WriteToOutputPin(GPIOA, TRIG_PIN, GPIO_PIN_RESET);

    // Wait for ECHO to go HIGH
    while (!GPIO_ReadFromInputPin(GPIOA, ECHO_PIN))
    {
        if (timeout-- == 0)
            return 0;   // timeout → no echo
    }

    // Measure HIGH pulse width
    uint32_t count = 0;
    timeout = 30000;
    while (GPIO_ReadFromInputPin(GPIOA, ECHO_PIN))
    {
        count++;
        delay_us(1);
        if (timeout-- == 0)
            break;
    }

    // Convert time to distance
    // distance = (time * speed of sound) / 2
    // speed of sound = 0.034 cm/us
    return (count * 34) / 2000;
}

// Initialize USART2
void USART2_Init(void)
{
    USART2Handle.pUSARTx = USART2;
    USART2Handle.USART_Config.USART_Baud = 9600;
    USART2Handle.USART_Config.USART_Mode = USART_MODE_TXRX;  // Corrected
    USART2Handle.USART_Config.USART_WordLength = USART_WORDLEN_8BITS;
    USART2Handle.USART_Config.USART_ParityControl = USART_PARITY_DISABLE;
    USART2Handle.USART_Config.USART_NoOfStopBits = USART_STOPBITS_1;
    USART2Handle.USART_Config.USART_HWFlowControl = USART_HW_FLOW_CTRL_NONE;

    USART_Init(&USART2Handle);
    USART_PeripheralControl(USART2, ENABLE);
}

int main(void)
{
    char buffer[50];
    uint32_t distance;

    // Enable GPIOA clock
