#include "stm32f446xx_gpio_driver.h"
#include "stm32f446xx_rcc_driver.h"
#include <stdio.h>
#include <stdint.h>

#define TRIG_PIN   GPIO_PIN_NO_0   // PA0 as Trigger
#define ECHO_PIN   GPIO_PIN_NO_1   // PA1 as Echo
#define LED_PIN    GPIO_PIN_NO_5   // PA5 onboard LED

volatile uint32_t micros = 0;

// SysTick interrupt handler increments micros every 1 µs
void SysTick_Handler(void) {
    micros++;
}

// delay in microseconds using SysTick counter
void delay_us(uint32_t us) {
    uint32_t start = micros;
    while ((micros - start) < us);
}

// measure distance in cm
uint32_t measure_distance_cm(void) {
    // Send 10us trigger pulse
    GPIO_WriteToOutputPin(GPIOA, TRIG_PIN, GPIO_PIN_RESET);
    delay_us(2);
    GPIO_WriteToOutputPin(GPIOA, TRIG_PIN, GPIO_PIN_SET);
    delay_us(10);
    GPIO_WriteToOutputPin(GPIOA, TRIG_PIN, GPIO_PIN_RESET);

    // Wait for echo high
    while (!GPIO_ReadFromInputPin(GPIOA, ECHO_PIN));

    // Measure echo pulse width
    uint32_t start = micros;
    while (GPIO_ReadFromInputPin(GPIOA, ECHO_PIN));
    uint32_t duration = micros - start;

    // Convert to distance (speed of sound ~0.034 cm/us)
    return (uint32_t)((duration * 0.034f) / 2.0f);
}

// redirect printf to SWV console
int _write(int file, char *ptr, int len) {
    for (int i = 0; i < len; i++) {
        ITM_SendChar(*ptr++);
    }
    return len;
}

int main(void) {
    // Init SysTick for 1 µs tick (SystemCoreClock must be set correctly)
    SysTick_Config(SystemCoreClock / 1000000);

    // --- TRIG pin (output) ---
    GPIO_Handle_t GpioTrig;
    GpioTrig.pGPIOx = GPIOA;
    GpioTrig.GPIO_PinConfig.GPIO_PinNumber = TRIG_PIN;
    GpioTrig.GPIO_PinConfig.GPIO_PinMode = GPIO_MODE_OUT;
    GpioTrig.GPIO_PinConfig.GPIO_PinSpeed = GPIO_SPEED_FAST;
    GpioTrig.GPIO_PinConfig.GPIO_PinOPType = GPIO_OP_TYPE_PP;
    GpioTrig.GPIO_PinConfig.GPIO_PinPuPdControl = GPIO_NO_PUPD;
    GPIO_Init(&GpioTrig);

    // --- ECHO pin (input) ---
    GPIO_Handle_t GpioEcho;
    GpioEcho.pGPIOx = GPIOA;
    GpioEcho.GPIO_PinConfig.GPIO_PinNumber = ECHO_PIN;
    GpioEcho.GPIO_PinConfig.GPIO_PinMode = GPIO_MODE_IN;
    GpioEcho.GPIO_PinConfig.GPIO_PinSpeed = GPIO_SPEED_FAST;
    GpioEcho.GPIO_PinConfig.GPIO_PinPuPdControl = GPIO_NO_PUPD;
    GPIO_Init(&GpioEcho);

    // --- LED pin (output) ---
    GPIO_Handle_t GpioLed;
    GpioLed.pGPIOx = GPIOA;
    GpioLed.GPIO_PinConfig.GPIO_PinNumber = LED_PIN;
    GpioLed.GPIO_PinConfig.GPIO_PinMode = GPIO_MODE_OUT;
    GpioLed.GPIO_PinConfig.GPIO_PinSpeed = GPIO_SPEED_FAST;
    GpioLed.GPIO_PinConfig.GPIO_PinOPType = GPIO_OP_TYPE_PP;
    GpioLed.GPIO_PinConfig.GPIO_PinPuPdControl = GPIO_NO_PUPD;
    GPIO_Init(&GpioLed);

    while (1) {
        uint32_t distance = measure_distance_cm();

        // print distance to SWV console
        printf("Distance: %lu cm\n", distance);

        if (distance > 2) {
            GPIO_WriteToOutputPin(GPIOA, LED_PIN, GPIO_PIN_SET);
            delay_us(200000); // LED ON for 200ms
            GPIO_WriteToOutputPin(GPIOA, LED_PIN, GPIO_PIN_RESET);
            delay_us(200000); // LED OFF for 200ms
        } else {
            GPIO_WriteToOutputPin(GPIOA, LED_PIN, GPIO_PIN_RESET);
        }
    }
}
