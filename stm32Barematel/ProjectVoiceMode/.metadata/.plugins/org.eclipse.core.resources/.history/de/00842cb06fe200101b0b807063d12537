#include "stm32f446xx.h"
#include "stm32f446xx_gpio_driver.h"
#include "stm32f446xx_usart_driver.h"
#include <string.h>

/* Global USART handle */
USART_Handle_t USART2Handle;

/* ---------- GPIO Init for USART2 TX (PA2) ---------- */
void USART2_GPIO_Init(void)
{
	GPIO_Handle_t gpio;

	gpio.pGPIOx = GPIOA;
	gpio.GPIO_PinConfig.GPIO_PinNumber = GPIO_PIN_NO_2;
	gpio.GPIO_PinConfig.GPIO_PinMode = GPIO_MODE_ALTFN;
	gpio.GPIO_PinConfig.GPIO_PinAltFunMode = 7;   // AF7 = USART2
	gpio.GPIO_PinConfig.GPIO_PinOPType = GPIO_OP_TYPE_PP;
	gpio.GPIO_PinConfig.GPIO_PinPuPdControl = GPIO_PIN_PU;
	gpio.GPIO_PinConfig.GPIO_PinSpeed = GPIO_SPEED_FAST;

	GPIO_Init(&gpio);
}

/* ---------- USART2 Init ---------- */
void USART2_Init(void)
{
	USART2Handle.pUSARTx = USART2;
	USART2Handle.USART_Config.USART_Baud = USART_STD_BAUD_9600;
	USART2Handle.USART_Config.USART_Mode = USART_MODE_ONLY_TX;
	USART2Handle.USART_Config.USART_WordLength = USART_WORDLEN_8BITS;
	USART2Handle.USART_Config.USART_ParityControl = USART_PARITY_DISABLE;
	USART2Handle.USART_Config.USART_NoOfStopBits = USART_STOPBITS_1;
	USART2Handle.USART_Config.USART_HWFlowControl = USART_HW_FLOW_CTRL_NONE;

	USART_Init(&USART2Handle);
	USART_PeripheralControl(USART2, ENABLE);
}

/* ---------- main ---------- */
int main(void)
{
	char msg[] = "hi\n";

	USART2_GPIO_Init();
	USART2_Init();

	while(1)
	{
		USART_SendData(&USART2Handle, (uint8_t*)msg, strlen(msg));

		// simple delay
		for(volatile uint32_t i = 0; i < 500000; i++);
	}
}
